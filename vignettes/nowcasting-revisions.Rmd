---
title: "Nowcasting Revisions"
output: rmarkdown::html_vignette
bibliography: references.bib
biblio-style: apalike
link-citations: true
vignette: >
  %\VignetteIndexEntry{nowcasting-revisions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Having some evidence that the revisions are predictable, we can now move to the next step: **nowcasting**. Nowcasting refers to the process of estimating the current state of the economy using timely indicators. In the context of revisions, nowcasting involves predicting the final (or efficient) value of an economic variable before all revisions are available. This vignette demonstrates how to implement a nowcasting model using the generalized Kishor-Koenig (KK) framework [@kishorVAREstimationForecasting2012].

## The Generalized Kishor-Koenig Model

The KK model extends the traditional Vector Autoregression (VAR) framework to account for data revisions explicitly. Unlike conventional models that treat data as final and accurate, the KK model recognizes that initial releases are subject to revisions, leading to biased and inefficient forecasts. By incorporating the revision process into a state-space framework, the KK model provides a reliable approach to nowcasting economic variables. Moreover, it nests several nowcasting models, such as the classical textbook measurement error model or the @howreyUsePreliminaryData1978 model.

The procedure is based on the assumption that there exists an efficient estimate $y_t^e$ of the final release that becomes available $e$ periods after the initial release $y_t^0$. We follow @strohsalDataRevisionsGerman2020 and assume that $e$th revision data follows an autoregressive model of order one (AR(1)). The state-space representation of the KK model is given by:

**1. The State Equation**
\[ z_t = F z_{t-1} + \nu_t \]

**2. The Observation Equation**
\[y_t = (I - G) F y_{t-1} + G z_t + \epsilon_t,\]

where 
\[ z'_t = \begin{bmatrix} y_{t-e}^e, y_{t-e +1}^e, ...,  y_t^e \end{bmatrix}' \]
\[ y'_t = \begin{bmatrix} y_{t-e}^e, y_{t-e +1}^{e-1}, ...,  y_t^0 \end{bmatrix}' \]
\[ \nu'_t = \begin{bmatrix} 0, 0, ...,  \nu_{0,t} \end{bmatrix}' \]
\[ \epsilon'_t = \begin{bmatrix} 0, \epsilon_{e-1,t}, ...,  \epsilon_{1,t}, \epsilon_{0,t} \end{bmatrix}' \]
\[
F = \begin{bmatrix} 0 & 1 & 0 & \dots & 0 \\
                      0 & 0 & 1 & \dots & 0 \\
                      \vdots & \vdots & \vdots & \ddots & \vdots \\
                      0 & 0 & 0 & \dots & 1 \\
                      0 & 0 & 0 & \dots & F_0 \end{bmatrix}
\]
\[
G = \begin{bmatrix} 1 & 0 & \dots & 0 \\
                      G_{e-1,e} & G_{e-1,e-1} & \dots & G_{e-1,0} \\
                      G_{e-2,e} & G_{e-2,e-1} & \dots & G_{e-2,0} \\
                      \vdots & \vdots & \ddots & \vdots \\
                      G_{0,e} & G_{0,e-1} & \dots & G_{0,0} \end{bmatrix}
\]
\( G \) is a gain matrix capturing the weight placed on new information, \( F \) determines the AR coefficient, and \( \nu_t \) and \( \epsilon_t \) are error vectors. The state-equation and observation-equation error vectors are assumed to be uncorrelated with one another at all leads and lags, and to be serially uncorrelated.

It is recommended to estimate this system using seemingly unrelated regression (SUR) to account for the correlation between the error terms in the state and observation equations. The SUR estimation is implemented in the `seem` package, which provides a convenient interface to estimate state-space models in R.


### 2.2 State-Space Representation
The KK model is formulated as a state-space system, consisting of a state equation describing the evolution of the true economic variable and an observation equation relating observed releases to the true value.

#### State Equation
The true value follows an autoregressive process:
\[
x_t = F x_{t-1} + \nu_t,
\]
where \( F \) is a coefficient matrix and \( \nu_t \) is a white noise error term.

#### Observation Equation
Observed releases are linked to the true value through:
\[
y_t^i = (I - G) F y_{t-1}^i + G x_t + \epsilon_t^i,
\]
where \( G \) is a gain matrix capturing the weight placed on new information, and \( \epsilon_t^i \) is a measurement error.

The matrices governing the revision process, \( F \) and \( G \), are structured as:
\[
F = \begin{bmatrix} 0 & 1 & 0 & \dots & 0 \\
                      0 & 0 & 1 & \dots & 0 \\
                      \vdots & \vdots & \vdots & \ddots & \vdots \\
                      0 & 0 & 0 & \dots & 1 \\
                      0 & 0 & 0 & \dots & F_0 \end{bmatrix},
\]
\[
G = \begin{bmatrix} 1 & 0 & \dots & 0 \\
                      G_{e-1,e} & G_{e-1,e-1} & \dots & G_{e-1,0} \\
                      G_{e-2,e} & G_{e-2,e-1} & \dots & G_{e-2,0} \\
                      \vdots & \vdots & \ddots & \vdots \\
                      G_{0,e} & G_{0,e-1} & \dots & G_{0,0} \end{bmatrix}.
\]

These matrices determine how revisions evolve over time and how efficiently new information is incorporated into data releases.

### 2.3 Model Estimation
The KK model is estimated using the Seemingly Unrelated Regression (SUR) method, allowing for correlations between measurement errors and the underlying economic variable. The Kalman filter is then applied to extract the best estimate of \( x_t \) from the observed data series \( y_t^i \). The Kalman update step is given by:
\[
\hat{x}_t = \hat{F} \hat{x}_{t-1} + K (y_t - H \hat{x}_t),
\]
where \( K \) is the Kalman gain matrix, and \( H \) is the observation mapping matrix.

**3. Conclusion**

The Kishor-Koenig model provides a robust framework for handling data revisions in macroeconomic forecasting. The autoregressive term in the revision process plays a crucial role by capturing the persistence of revisions, which helps refine early estimates by incorporating information from past revisions. If revisions are predictable, they should be accounted for in real-time estimates to enhance forecast accuracy. By explicitly modeling the revision process, the KK model offers a significant improvement over traditional VAR models, making it a valuable tool for policymakers and economists seeking to generate more accurate real-time estimates. The use of the state-space approach, combined with Kalman filtering, ensures that forecasts are dynamically updated as new information becomes available.




```{r warning = FALSE, message=FALSE, eval=FALSE}
library(reviser)
library(dplyr)
library(lubridate)

gdp <- reviser::gdp %>%
  tsbox::ts_pc() %>%
  filter(id == "US",
         time > min(pub_date),
         time <= as.Date("2020-01-01")
         ) %>%
  na.omit()

xx<-df %>% group_by(pub_date, release) %>%
  mutate(n=n())

df <- gdp
min_pub_date <- min(df$pub_date)
      max_time <- max(df$time[df$pub_date == min_pub_date])
      df <- df %>%
        dplyr::filter(
          time >= max_time
        )
      
xx<-vintages_wide(df)$CHE

df <- get_nth_release(gdp, n = 0:14, diagonal = F)

final_release <- get_nth_release(gdp, n = 15)
final_release <- get_nth_release(gdp, n = "latest")

efficient_release <- get_first_efficient_release(
    df,
    final_release
  )

summary(efficient_release)


nowcast <- kk_nowcast(
    efficient_release$data, 
    e = efficient_release$e,
    model = "KK",
    method = "SUR"#,
    #solver_options = list(startvals = kk_nowcast(efficient_release$data, e = efficient_release$e, model = "KK", method = "OLS")$params)
  )


nowcast$params
summary(nowcast$fit[[1]])
xxx<-nowcast$filtered_z

eff_rel_pred_full <- (nowcast$filtered_states[,c(1,2+nowcast$e)])

final_vals <- vintages_wide(efficient_release$data, names_from = "release")[,c("time", "final")]

first_vals <- vintages_wide(efficient_release$data, names_from = "release")[,c(1,2)]


data <- full_join(
  first_vals,
  eff_rel_pred_full,
  by = "time"
) %>% full_join(
  final_vals,
  by = "time"
) %>% rename(
  "nowcast_full" = 3,
  "final" = 4,
  "first" = 2
) %>% arrange(time)

data1 <- na.omit(data) %>%
  filter(!year(time) %in% c(2020, 2021)) %>%
  mutate(
    mse_full = mean((nowcast_full - final)^2),
    mse_first = mean((first - final)^2)
  )

```
